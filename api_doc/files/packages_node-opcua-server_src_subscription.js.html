<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N63SL9Q');</script>
    <!-- End Google Tag Manager -->

    <title>packages/node-opcua-server/src/subscription.js - The NodeOPCUA API</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-8886208393040088",
            enable_page_level_ads: true
        });
    </script>

</head>
<body class="yui3-skin-sam">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N63SL9Q"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="The NodeOPCUA API" src="../assets/css/logo.png" style="max-height: 65%;" title="The NodeOPCUA API">
            The NodeOPCUA API
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>0.1.0-pre</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/AcknowledgeMessage", "classes/ActivateSessionRequest", "classes/ActivateSessionResponse", "classes/AddNodesItem", "classes/AddNodesRequest", "classes/AddNodesResponse", "classes/AddNodesResult", "classes/AddReferencesItem", "classes/AddReferencesRequest", "classes/AddReferencesResponse", "classes/AddressSpace", "classes/AggregateConfiguration", "classes/AggregateFilter", "classes/AnonymousIdentityToken", "classes/ApplicationDescription", "classes/ApplicationInstanceCertificate", "classes/Argument", "classes/AsymmetricAlgorithmSecurityHeader", "classes/AttributeIds", "classes/AttributeNameById", "classes/AttributeOperand", "classes/AxisInformation", "classes/BaseEventType", "classes/BaseNode", "classes/BaseUAObject", "classes/BinaryStream", "classes/BinaryStreamSizeCalculator", "classes/BrowseDescription", "classes/BrowseDirection", "classes/BrowseNextRequest", "classes/BrowseNextResponse", "classes/BrowsePath", "classes/BrowsePathResult", "classes/BrowsePathTarget", "classes/BrowseRequest", "classes/BrowseResponse", "classes/BrowseResult", "classes/BuildInfo", "classes/CallMethodRequest", "classes/CallMethodResult", "classes/CallRequest", "classes/CallResponse", "classes/CancelRequest", "classes/CancelResponse", "classes/ChannelSecurityToken", "classes/ChunkManager", "classes/ClientMonitoredItem", "classes/ClientMonitoredItemGroup", "classes/ClientSecureChannelLayer", "classes/ClientSession", "classes/ClientSidePublishEngine", "classes/ClientSubscription", "classes/ClientTCP_transport", "classes/CloseSecureChannelRequest", "classes/CloseSecureChannelResponse", "classes/CloseSessionRequest", "classes/CloseSessionResponse", "classes/Company", "classes/ConditionInfo", "classes/ConditionSnapshot", "classes/ContentFilter", "classes/ContentFilterElement", "classes/ContentFilterElementResult", "classes/ContentFilterResult", "classes/CreateMonitoredItemsRequest", "classes/CreateMonitoredItemsResponse", "classes/CreateSessionRequest", "classes/CreateSessionResponse", "classes/CreateSubscriptionRequest", "classes/CreateSubscriptionResponse", "classes/DataChangeFilter", "classes/DataChangeNotification", "classes/DataValue", "classes/DeleteMonitoredItemsRequest", "classes/DeleteMonitoredItemsResponse", "classes/DeleteNodesItem", "classes/DeleteNodesRequest", "classes/DeleteNodesResponse", "classes/DeleteReferencesItem", "classes/DeleteReferencesRequest", "classes/DeleteReferencesResponse", "classes/DeleteSubscriptionsRequest", "classes/DeleteSubscriptionsResponse", "classes/DiagnosticInfo", "classes/DummyObject", "classes/ElementOperand", "classes/Employee", "classes/EndpointDescription", "classes/Enum", "classes/EnumValueType", "classes/ErrorMessage", "classes/EUInformation", "classes/EventData", "classes/EventFieldList", "classes/EventFilter", "classes/EventFilterResult", "classes/EventNotificationList", "classes/ExpandedNodeId", "classes/Factory", "classes/FilterOperand", "classes/FindServersRequest", "classes/FindServersResponse", "classes/FooBar", "classes/FooBarDerived", "classes/FooWithRecursion", "classes/GetEndpointsRequest", "classes/GetEndpointsResponse", "classes/HelloMessage", "classes/HistoryData", "classes/HistoryModifiedData", "classes/HistoryReadDetails", "classes/HistoryReadRequest", "classes/HistoryReadResponse", "classes/HistoryReadResult", "classes/HistoryReadValueId", "classes/HistoryServerCapabilities", "classes/HistoryUpdateRequest", "classes/HistoryUpdateResponse", "classes/HistoryUpdateResult", "classes/IssuedIdentityToken", "classes/LiteralOperand", "classes/LocalizedText", "classes/MessageBuilder", "classes/MessageBuilderBase", "classes/MessageChunker", "classes/MetaShapeForUnitTest", "classes/ModelChangeStructure", "classes/ModificationInfo", "classes/ModifyMonitoredItemsRequest", "classes/ModifyMonitoredItemsResponse", "classes/ModifySubscriptionRequest", "classes/ModifySubscriptionResponse", "classes/MonitoredItem", "classes/MonitoredItemCreateRequest", "classes/MonitoredItemCreateResult", "classes/MonitoredItemModifyRequest", "classes/MonitoredItemModifyResult", "classes/MonitoredItemNotification", "classes/MonitoringFilter", "classes/MonitoringParameters", "classes/NodeCrawler", "classes/NodeId", "classes/NodeIdType", "classes/NodeTypeDescription", "classes/NotificationMessage", "classes/ObjWithAccessLevel", "classes/ObjWithIntegerId", "classes/opcua", "classes/OPCUABaseServer", "classes/OPCUAClient", "classes/OPCUAClientBase", "classes/OPCUASecureObject", "classes/OPCUAServer", "classes/OPCUAServerEndPoint

A sever end point is listening to one port", "classes/OpenSecureChannelRequest", "classes/OpenSecureChannelResponse", "classes/OperationLimits", "classes/PacketAssembler", "classes/ParsingResult", "classes/Person", "classes/Person2", "classes/Potato", "classes/PublishRequest", "classes/PublishResponse", "classes/QualifiedName", "classes/QueryDataDescription", "classes/QueryDataSet", "classes/QueryFirstRequest", "classes/QueryFirstResponse", "classes/QueryNextRequest", "classes/QueryNextResponse", "classes/Range", "classes/ReadAtTimeDetails", "classes/ReaderState", "classes/ReadEventDetails", "classes/ReadProcessedDetails", "classes/ReadRawModifiedDetails", "classes/ReadRequest", "classes/ReadResponse", "classes/ReadValueId", "classes/RedundantServer", "classes/Reference", "classes/ReferenceDescription", "classes/ReferenceType", "classes/RegisteredServer", "classes/RegisterNodesRequest", "classes/RegisterNodesResponse", "classes/RegisterServerRequest", "classes/RegisterServerResponse", "classes/RelativePath", "classes/RelativePathElement", "classes/RepublishRequest", "classes/RepublishResponse", "classes/RequestHeader", "classes/ResponseHeader", "classes/Role", "classes/SamplingIntervalDiagnostics", "classes/SecureMessageChunkManager", "classes/SecurityPolicy", "classes/SemanticChangeStructure", "classes/SequenceHeader", "classes/SequenceNumberGenerator", "classes/ServerCapabilities", "classes/ServerDiagnosticsSummary", "classes/ServerEngine", "classes/ServerSecureChannelLayer", "classes/ServerSession", "classes/ServerSidePublishEngine", "classes/ServerSideUnimplementedRequest", "classes/ServerStatus", "classes/ServerTCP_transport", "classes/ServiceCounter", "classes/ServiceFault", "classes/SessionDiagnostics", "classes/SessionSecurityDiagnostics", "classes/SetMonitoringModeRequest", "classes/SetMonitoringModeResponse", "classes/SetPublishingModeRequest", "classes/SetPublishingModeResponse", "classes/SetTriggeringRequest", "classes/SetTriggeringResponse", "classes/Shape", "classes/SignatureData", "classes/SignedSoftwareCertificate", "classes/SimpleAttributeOperand", "classes/Simulator", "classes/StatusChangeNotification", "classes/StatusCode", "classes/Subscription", "classes/SubscriptionAcknowledgement", "classes/SubscriptionDiagnostics", "classes/SymmetricAlgorithmSecurityHeader", "classes/TCP_transport", "classes/TCPErrorMessage", "classes/TimestampsToReturn", "classes/TimeZone", "classes/ToolBrowsePath", "classes/TransferResult", "classes/TransferSubscriptionsRequest", "classes/TransferSubscriptionsResponse", "classes/TranslateBrowsePathsToNodeIdsRequest", "classes/TranslateBrowsePathsToNodeIdsResponse", "classes/TypeSchema", "classes/UAAcknowledgeableConditionBase", "classes/UAAlarmConditionBase", "classes/UACertificateExpirationAlarm", "classes/UAConditionBase", "classes/UADataType", "classes/UADiscreteAlarm", "classes/UAExclusiveDeviationAlarm", "classes/UAExclusiveLevelAlarm", "classes/UAExclusiveLimitAlarm", "classes/UAExclusiveRateOfChangeAlarm", "classes/UALimitAlarm", "classes/UANonExclusiveDeviationAlarm", "classes/UANonExclusiveLimitAlarm", "classes/UAObject", "classes/UAObjectType", "classes/UAOffNormalAlarm", "classes/UASystemOffNormalAlarm", "classes/UATripAlarm", "classes/UATwoStateVariable", "classes/UAVariable", "classes/UAVariableType", "classes/UnregisterNodesRequest", "classes/UnregisterNodesResponse", "classes/UserNameIdentityToken", "classes/UserTokenPolicy", "classes/Variant", "classes/View", "classes/ViewDescription", "classes/WriteRequest", "classes/WriteResponse", "classes/WriteValue", "classes/X509IdentityToken", "classes/Xml2Json", "modules/opcua.address_space", "modules/opcua.address_space.AlarmsAndConditions", "modules/opcua.address_space.types", "modules/opcua.client", "modules/opcua.data-value", "modules/opcua.datamodel", "modules/opcua.miscellaneous", "modules/opcua.server", "modules/opcua.server.simulation", "modules/opcua.status-code", "modules/opcua.transport", "modules/opcua.utils", "modules/opcua.variant", "modules/service.filter.tools", "modules/services.browse", "modules/services.call", "modules/services.discovery", "modules/services.endpoints", "modules/services.filter", "modules/services.history", "modules/services.node_management", "modules/services.query", "modules/services.read", "modules/services.register-server", "modules/services.register_node", "modules/services.secure-channel", "modules/services.session", "modules/services.subscription", "modules/services.translate-browse-path", "modules/services.write", "modules/StatusCodes", "modules/xml2json

node -> see if https://github.com/isaacs/sax-js could be used instead"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/AcknowledgeMessage.html">AcknowledgeMessage</a></li>
	                            <li><a href="../classes/ActivateSessionRequest.html">ActivateSessionRequest</a></li>
	                            <li><a href="../classes/ActivateSessionResponse.html">ActivateSessionResponse</a></li>
	                            <li><a href="../classes/AddNodesItem.html">AddNodesItem</a></li>
	                            <li><a href="../classes/AddNodesRequest.html">AddNodesRequest</a></li>
	                            <li><a href="../classes/AddNodesResponse.html">AddNodesResponse</a></li>
	                            <li><a href="../classes/AddNodesResult.html">AddNodesResult</a></li>
	                            <li><a href="../classes/AddReferencesItem.html">AddReferencesItem</a></li>
	                            <li><a href="../classes/AddReferencesRequest.html">AddReferencesRequest</a></li>
	                            <li><a href="../classes/AddReferencesResponse.html">AddReferencesResponse</a></li>
	                            <li><a href="../classes/AddressSpace.html">AddressSpace</a></li>
	                            <li><a href="../classes/AggregateConfiguration.html">AggregateConfiguration</a></li>
	                            <li><a href="../classes/AggregateFilter.html">AggregateFilter</a></li>
	                            <li><a href="../classes/AnonymousIdentityToken.html">AnonymousIdentityToken</a></li>
	                            <li><a href="../classes/ApplicationDescription.html">ApplicationDescription</a></li>
	                            <li><a href="../classes/ApplicationInstanceCertificate.html">ApplicationInstanceCertificate</a></li>
	                            <li><a href="../classes/Argument.html">Argument</a></li>
	                            <li><a href="../classes/AsymmetricAlgorithmSecurityHeader.html">AsymmetricAlgorithmSecurityHeader</a></li>
	                            <li><a href="../classes/AttributeIds.html">AttributeIds</a></li>
	                            <li><a href="../classes/AttributeNameById.html">AttributeNameById</a></li>
	                            <li><a href="../classes/AttributeOperand.html">AttributeOperand</a></li>
	                            <li><a href="../classes/AxisInformation.html">AxisInformation</a></li>
	                            <li><a href="../classes/BaseEventType.html">BaseEventType</a></li>
	                            <li><a href="../classes/BaseNode.html">BaseNode</a></li>
	                            <li><a href="../classes/BaseUAObject.html">BaseUAObject</a></li>
	                            <li><a href="../classes/BinaryStream.html">BinaryStream</a></li>
	                            <li><a href="../classes/BinaryStreamSizeCalculator.html">BinaryStreamSizeCalculator</a></li>
	                            <li><a href="../classes/BrowseDescription.html">BrowseDescription</a></li>
	                            <li><a href="../classes/BrowseDirection.html">BrowseDirection</a></li>
	                            <li><a href="../classes/BrowseNextRequest.html">BrowseNextRequest</a></li>
	                            <li><a href="../classes/BrowseNextResponse.html">BrowseNextResponse</a></li>
	                            <li><a href="../classes/BrowsePath.html">BrowsePath</a></li>
	                            <li><a href="../classes/BrowsePathResult.html">BrowsePathResult</a></li>
	                            <li><a href="../classes/BrowsePathTarget.html">BrowsePathTarget</a></li>
	                            <li><a href="../classes/BrowseRequest.html">BrowseRequest</a></li>
	                            <li><a href="../classes/BrowseResponse.html">BrowseResponse</a></li>
	                            <li><a href="../classes/BrowseResult.html">BrowseResult</a></li>
	                            <li><a href="../classes/BuildInfo.html">BuildInfo</a></li>
	                            <li><a href="../classes/CallMethodRequest.html">CallMethodRequest</a></li>
	                            <li><a href="../classes/CallMethodResult.html">CallMethodResult</a></li>
	                            <li><a href="../classes/CallRequest.html">CallRequest</a></li>
	                            <li><a href="../classes/CallResponse.html">CallResponse</a></li>
	                            <li><a href="../classes/CancelRequest.html">CancelRequest</a></li>
	                            <li><a href="../classes/CancelResponse.html">CancelResponse</a></li>
	                            <li><a href="../classes/ChannelSecurityToken.html">ChannelSecurityToken</a></li>
	                            <li><a href="../classes/ChunkManager.html">ChunkManager</a></li>
	                            <li><a href="../classes/ClientMonitoredItem.html">ClientMonitoredItem</a></li>
	                            <li><a href="../classes/ClientMonitoredItemGroup.html">ClientMonitoredItemGroup</a></li>
	                            <li><a href="../classes/ClientSecureChannelLayer.html">ClientSecureChannelLayer</a></li>
	                            <li><a href="../classes/ClientSession.html">ClientSession</a></li>
	                            <li><a href="../classes/ClientSidePublishEngine.html">ClientSidePublishEngine</a></li>
	                            <li><a href="../classes/ClientSubscription.html">ClientSubscription</a></li>
	                            <li><a href="../classes/ClientTCP_transport.html">ClientTCP_transport</a></li>
	                            <li><a href="../classes/CloseSecureChannelRequest.html">CloseSecureChannelRequest</a></li>
	                            <li><a href="../classes/CloseSecureChannelResponse.html">CloseSecureChannelResponse</a></li>
	                            <li><a href="../classes/CloseSessionRequest.html">CloseSessionRequest</a></li>
	                            <li><a href="../classes/CloseSessionResponse.html">CloseSessionResponse</a></li>
	                            <li><a href="../classes/Company.html">Company</a></li>
	                            <li><a href="../classes/ConditionInfo.html">ConditionInfo</a></li>
	                            <li><a href="../classes/ContentFilter.html">ContentFilter</a></li>
	                            <li><a href="../classes/ContentFilterElement.html">ContentFilterElement</a></li>
	                            <li><a href="../classes/ContentFilterElementResult.html">ContentFilterElementResult</a></li>
	                            <li><a href="../classes/ContentFilterResult.html">ContentFilterResult</a></li>
	                            <li><a href="../classes/CreateMonitoredItemsRequest.html">CreateMonitoredItemsRequest</a></li>
	                            <li><a href="../classes/CreateMonitoredItemsResponse.html">CreateMonitoredItemsResponse</a></li>
	                            <li><a href="../classes/CreateSessionRequest.html">CreateSessionRequest</a></li>
	                            <li><a href="../classes/CreateSessionResponse.html">CreateSessionResponse</a></li>
	                            <li><a href="../classes/CreateSubscriptionRequest.html">CreateSubscriptionRequest</a></li>
	                            <li><a href="../classes/CreateSubscriptionResponse.html">CreateSubscriptionResponse</a></li>
	                            <li><a href="../classes/DataChangeFilter.html">DataChangeFilter</a></li>
	                            <li><a href="../classes/DataChangeNotification.html">DataChangeNotification</a></li>
	                            <li><a href="../classes/DataValue.html">DataValue</a></li>
	                            <li><a href="../classes/DeleteMonitoredItemsRequest.html">DeleteMonitoredItemsRequest</a></li>
	                            <li><a href="../classes/DeleteMonitoredItemsResponse.html">DeleteMonitoredItemsResponse</a></li>
	                            <li><a href="../classes/DeleteNodesItem.html">DeleteNodesItem</a></li>
	                            <li><a href="../classes/DeleteNodesRequest.html">DeleteNodesRequest</a></li>
	                            <li><a href="../classes/DeleteNodesResponse.html">DeleteNodesResponse</a></li>
	                            <li><a href="../classes/DeleteReferencesItem.html">DeleteReferencesItem</a></li>
	                            <li><a href="../classes/DeleteReferencesRequest.html">DeleteReferencesRequest</a></li>
	                            <li><a href="../classes/DeleteReferencesResponse.html">DeleteReferencesResponse</a></li>
	                            <li><a href="../classes/DeleteSubscriptionsRequest.html">DeleteSubscriptionsRequest</a></li>
	                            <li><a href="../classes/DeleteSubscriptionsResponse.html">DeleteSubscriptionsResponse</a></li>
	                            <li><a href="../classes/DiagnosticInfo.html">DiagnosticInfo</a></li>
	                            <li><a href="../classes/DummyObject.html">DummyObject</a></li>
	                            <li><a href="../classes/ElementOperand.html">ElementOperand</a></li>
	                            <li><a href="../classes/Employee.html">Employee</a></li>
	                            <li><a href="../classes/EndpointDescription.html">EndpointDescription</a></li>
	                            <li><a href="../classes/Enum.html">Enum</a></li>
	                            <li><a href="../classes/EnumValueType.html">EnumValueType</a></li>
	                            <li><a href="../classes/ErrorMessage.html">ErrorMessage</a></li>
	                            <li><a href="../classes/EUInformation.html">EUInformation</a></li>
	                            <li><a href="../classes/EventData.html">EventData</a></li>
	                            <li><a href="../classes/EventFieldList.html">EventFieldList</a></li>
	                            <li><a href="../classes/EventFilter.html">EventFilter</a></li>
	                            <li><a href="../classes/EventFilterResult.html">EventFilterResult</a></li>
	                            <li><a href="../classes/EventNotificationList.html">EventNotificationList</a></li>
	                            <li><a href="../classes/ExpandedNodeId.html">ExpandedNodeId</a></li>
	                            <li><a href="../classes/Factory.html">Factory</a></li>
	                            <li><a href="../classes/FilterOperand.html">FilterOperand</a></li>
	                            <li><a href="../classes/FindServersRequest.html">FindServersRequest</a></li>
	                            <li><a href="../classes/FindServersResponse.html">FindServersResponse</a></li>
	                            <li><a href="../classes/FooBar.html">FooBar</a></li>
	                            <li><a href="../classes/FooBarDerived.html">FooBarDerived</a></li>
	                            <li><a href="../classes/FooWithRecursion.html">FooWithRecursion</a></li>
	                            <li><a href="../classes/GetEndpointsRequest.html">GetEndpointsRequest</a></li>
	                            <li><a href="../classes/GetEndpointsResponse.html">GetEndpointsResponse</a></li>
	                            <li><a href="../classes/HelloMessage.html">HelloMessage</a></li>
	                            <li><a href="../classes/HistoryData.html">HistoryData</a></li>
	                            <li><a href="../classes/HistoryModifiedData.html">HistoryModifiedData</a></li>
	                            <li><a href="../classes/HistoryReadDetails.html">HistoryReadDetails</a></li>
	                            <li><a href="../classes/HistoryReadRequest.html">HistoryReadRequest</a></li>
	                            <li><a href="../classes/HistoryReadResponse.html">HistoryReadResponse</a></li>
	                            <li><a href="../classes/HistoryReadResult.html">HistoryReadResult</a></li>
	                            <li><a href="../classes/HistoryReadValueId.html">HistoryReadValueId</a></li>
	                            <li><a href="../classes/HistoryServerCapabilities.html">HistoryServerCapabilities</a></li>
	                            <li><a href="../classes/HistoryUpdateRequest.html">HistoryUpdateRequest</a></li>
	                            <li><a href="../classes/HistoryUpdateResponse.html">HistoryUpdateResponse</a></li>
	                            <li><a href="../classes/HistoryUpdateResult.html">HistoryUpdateResult</a></li>
	                            <li><a href="../classes/IssuedIdentityToken.html">IssuedIdentityToken</a></li>
	                            <li><a href="../classes/LiteralOperand.html">LiteralOperand</a></li>
	                            <li><a href="../classes/LocalizedText.html">LocalizedText</a></li>
	                            <li><a href="../classes/MessageBuilder.html">MessageBuilder</a></li>
	                            <li><a href="../classes/MessageBuilderBase.html">MessageBuilderBase</a></li>
	                            <li><a href="../classes/MessageChunker.html">MessageChunker</a></li>
	                            <li><a href="../classes/MetaShapeForUnitTest.html">MetaShapeForUnitTest</a></li>
	                            <li><a href="../classes/ModelChangeStructure.html">ModelChangeStructure</a></li>
	                            <li><a href="../classes/ModificationInfo.html">ModificationInfo</a></li>
	                            <li><a href="../classes/ModifyMonitoredItemsRequest.html">ModifyMonitoredItemsRequest</a></li>
	                            <li><a href="../classes/ModifyMonitoredItemsResponse.html">ModifyMonitoredItemsResponse</a></li>
	                            <li><a href="../classes/ModifySubscriptionRequest.html">ModifySubscriptionRequest</a></li>
	                            <li><a href="../classes/ModifySubscriptionResponse.html">ModifySubscriptionResponse</a></li>
	                            <li><a href="../classes/MonitoredItem.html">MonitoredItem</a></li>
	                            <li><a href="../classes/MonitoredItemCreateRequest.html">MonitoredItemCreateRequest</a></li>
	                            <li><a href="../classes/MonitoredItemCreateResult.html">MonitoredItemCreateResult</a></li>
	                            <li><a href="../classes/MonitoredItemModifyRequest.html">MonitoredItemModifyRequest</a></li>
	                            <li><a href="../classes/MonitoredItemModifyResult.html">MonitoredItemModifyResult</a></li>
	                            <li><a href="../classes/MonitoredItemNotification.html">MonitoredItemNotification</a></li>
	                            <li><a href="../classes/MonitoringFilter.html">MonitoringFilter</a></li>
	                            <li><a href="../classes/MonitoringParameters.html">MonitoringParameters</a></li>
	                            <li><a href="../classes/NodeCrawler.html">NodeCrawler</a></li>
	                            <li><a href="../classes/NodeId.html">NodeId</a></li>
	                            <li><a href="../classes/NodeIdType.html">NodeIdType</a></li>
	                            <li><a href="../classes/NodeTypeDescription.html">NodeTypeDescription</a></li>
	                            <li><a href="../classes/NotificationMessage.html">NotificationMessage</a></li>
	                            <li><a href="../classes/ObjWithAccessLevel.html">ObjWithAccessLevel</a></li>
	                            <li><a href="../classes/ObjWithIntegerId.html">ObjWithIntegerId</a></li>
	                            <li><a href="../classes/opcua.html">opcua</a></li>
	                            <li><a href="../classes/OPCUABaseServer.html">OPCUABaseServer</a></li>
	                            <li><a href="../classes/OPCUAClient.html">OPCUAClient</a></li>
	                            <li><a href="../classes/OPCUAClientBase.html">OPCUAClientBase</a></li>
	                            <li><a href="../classes/OPCUASecureObject.html">OPCUASecureObject</a></li>
	                            <li><a href="../classes/OPCUAServer.html">OPCUAServer</a></li>
	                            <li><a href="../classes/OPCUAServerEndPoint
	    
	    A sever end point is listening to one port.html">OPCUAServerEndPoint
	    
	    A sever end point is listening to one port</a></li>
	                            <li><a href="../classes/OpenSecureChannelRequest.html">OpenSecureChannelRequest</a></li>
	                            <li><a href="../classes/OpenSecureChannelResponse.html">OpenSecureChannelResponse</a></li>
	                            <li><a href="../classes/OperationLimits.html">OperationLimits</a></li>
	                            <li><a href="../classes/PacketAssembler.html">PacketAssembler</a></li>
	                            <li><a href="../classes/ParsingResult.html">ParsingResult</a></li>
	                            <li><a href="../classes/Person.html">Person</a></li>
	                            <li><a href="../classes/Person2.html">Person2</a></li>
	                            <li><a href="../classes/Potato.html">Potato</a></li>
	                            <li><a href="../classes/PublishRequest.html">PublishRequest</a></li>
	                            <li><a href="../classes/PublishResponse.html">PublishResponse</a></li>
	                            <li><a href="../classes/QualifiedName.html">QualifiedName</a></li>
	                            <li><a href="../classes/QueryDataDescription.html">QueryDataDescription</a></li>
	                            <li><a href="../classes/QueryDataSet.html">QueryDataSet</a></li>
	                            <li><a href="../classes/QueryFirstRequest.html">QueryFirstRequest</a></li>
	                            <li><a href="../classes/QueryFirstResponse.html">QueryFirstResponse</a></li>
	                            <li><a href="../classes/QueryNextRequest.html">QueryNextRequest</a></li>
	                            <li><a href="../classes/QueryNextResponse.html">QueryNextResponse</a></li>
	                            <li><a href="../classes/Range.html">Range</a></li>
	                            <li><a href="../classes/ReadAtTimeDetails.html">ReadAtTimeDetails</a></li>
	                            <li><a href="../classes/ReadEventDetails.html">ReadEventDetails</a></li>
	                            <li><a href="../classes/ReadProcessedDetails.html">ReadProcessedDetails</a></li>
	                            <li><a href="../classes/ReadRawModifiedDetails.html">ReadRawModifiedDetails</a></li>
	                            <li><a href="../classes/ReadRequest.html">ReadRequest</a></li>
	                            <li><a href="../classes/ReadResponse.html">ReadResponse</a></li>
	                            <li><a href="../classes/ReadValueId.html">ReadValueId</a></li>
	                            <li><a href="../classes/RedundantServer.html">RedundantServer</a></li>
	                            <li><a href="../classes/Reference.html">Reference</a></li>
	                            <li><a href="../classes/ReferenceDescription.html">ReferenceDescription</a></li>
	                            <li><a href="../classes/ReferenceType.html">ReferenceType</a></li>
	                            <li><a href="../classes/RegisteredServer.html">RegisteredServer</a></li>
	                            <li><a href="../classes/RegisterNodesRequest.html">RegisterNodesRequest</a></li>
	                            <li><a href="../classes/RegisterNodesResponse.html">RegisterNodesResponse</a></li>
	                            <li><a href="../classes/RegisterServerRequest.html">RegisterServerRequest</a></li>
	                            <li><a href="../classes/RegisterServerResponse.html">RegisterServerResponse</a></li>
	                            <li><a href="../classes/RelativePath.html">RelativePath</a></li>
	                            <li><a href="../classes/RelativePathElement.html">RelativePathElement</a></li>
	                            <li><a href="../classes/RepublishRequest.html">RepublishRequest</a></li>
	                            <li><a href="../classes/RepublishResponse.html">RepublishResponse</a></li>
	                            <li><a href="../classes/RequestHeader.html">RequestHeader</a></li>
	                            <li><a href="../classes/ResponseHeader.html">ResponseHeader</a></li>
	                            <li><a href="../classes/Role.html">Role</a></li>
	                            <li><a href="../classes/SamplingIntervalDiagnostics.html">SamplingIntervalDiagnostics</a></li>
	                            <li><a href="../classes/SecureMessageChunkManager.html">SecureMessageChunkManager</a></li>
	                            <li><a href="../classes/SecurityPolicy.html">SecurityPolicy</a></li>
	                            <li><a href="../classes/SemanticChangeStructure.html">SemanticChangeStructure</a></li>
	                            <li><a href="../classes/SequenceHeader.html">SequenceHeader</a></li>
	                            <li><a href="../classes/SequenceNumberGenerator.html">SequenceNumberGenerator</a></li>
	                            <li><a href="../classes/ServerCapabilities.html">ServerCapabilities</a></li>
	                            <li><a href="../classes/ServerDiagnosticsSummary.html">ServerDiagnosticsSummary</a></li>
	                            <li><a href="../classes/ServerEngine.html">ServerEngine</a></li>
	                            <li><a href="../classes/ServerSecureChannelLayer.html">ServerSecureChannelLayer</a></li>
	                            <li><a href="../classes/ServerSidePublishEngine.html">ServerSidePublishEngine</a></li>
	                            <li><a href="../classes/ServerSideUnimplementedRequest.html">ServerSideUnimplementedRequest</a></li>
	                            <li><a href="../classes/ServerStatus.html">ServerStatus</a></li>
	                            <li><a href="../classes/ServerTCP_transport.html">ServerTCP_transport</a></li>
	                            <li><a href="../classes/ServiceCounter.html">ServiceCounter</a></li>
	                            <li><a href="../classes/ServiceFault.html">ServiceFault</a></li>
	                            <li><a href="../classes/SessionDiagnostics.html">SessionDiagnostics</a></li>
	                            <li><a href="../classes/SessionSecurityDiagnostics.html">SessionSecurityDiagnostics</a></li>
	                            <li><a href="../classes/SetMonitoringModeRequest.html">SetMonitoringModeRequest</a></li>
	                            <li><a href="../classes/SetMonitoringModeResponse.html">SetMonitoringModeResponse</a></li>
	                            <li><a href="../classes/SetPublishingModeRequest.html">SetPublishingModeRequest</a></li>
	                            <li><a href="../classes/SetPublishingModeResponse.html">SetPublishingModeResponse</a></li>
	                            <li><a href="../classes/SetTriggeringRequest.html">SetTriggeringRequest</a></li>
	                            <li><a href="../classes/SetTriggeringResponse.html">SetTriggeringResponse</a></li>
	                            <li><a href="../classes/Shape.html">Shape</a></li>
	                            <li><a href="../classes/SignatureData.html">SignatureData</a></li>
	                            <li><a href="../classes/SignedSoftwareCertificate.html">SignedSoftwareCertificate</a></li>
	                            <li><a href="../classes/SimpleAttributeOperand.html">SimpleAttributeOperand</a></li>
	                            <li><a href="../classes/Simulator.html">Simulator</a></li>
	                            <li><a href="../classes/StatusChangeNotification.html">StatusChangeNotification</a></li>
	                            <li><a href="../classes/StatusCode.html">StatusCode</a></li>
	                            <li><a href="../classes/Subscription.html">Subscription</a></li>
	                            <li><a href="../classes/SubscriptionAcknowledgement.html">SubscriptionAcknowledgement</a></li>
	                            <li><a href="../classes/SubscriptionDiagnostics.html">SubscriptionDiagnostics</a></li>
	                            <li><a href="../classes/SymmetricAlgorithmSecurityHeader.html">SymmetricAlgorithmSecurityHeader</a></li>
	                            <li><a href="../classes/TCP_transport.html">TCP_transport</a></li>
	                            <li><a href="../classes/TCPErrorMessage.html">TCPErrorMessage</a></li>
	                            <li><a href="../classes/TimestampsToReturn.html">TimestampsToReturn</a></li>
	                            <li><a href="../classes/TimeZone.html">TimeZone</a></li>
	                            <li><a href="../classes/ToolBrowsePath.html">ToolBrowsePath</a></li>
	                            <li><a href="../classes/TransferResult.html">TransferResult</a></li>
	                            <li><a href="../classes/TransferSubscriptionsRequest.html">TransferSubscriptionsRequest</a></li>
	                            <li><a href="../classes/TransferSubscriptionsResponse.html">TransferSubscriptionsResponse</a></li>
	                            <li><a href="../classes/TranslateBrowsePathsToNodeIdsRequest.html">TranslateBrowsePathsToNodeIdsRequest</a></li>
	                            <li><a href="../classes/TranslateBrowsePathsToNodeIdsResponse.html">TranslateBrowsePathsToNodeIdsResponse</a></li>
	                            <li><a href="../classes/TypeSchema.html">TypeSchema</a></li>
	                            <li><a href="../classes/UAAcknowledgeableConditionBase.html">UAAcknowledgeableConditionBase</a></li>
	                            <li><a href="../classes/UAAlarmConditionBase.html">UAAlarmConditionBase</a></li>
	                            <li><a href="../classes/UACertificateExpirationAlarm.html">UACertificateExpirationAlarm</a></li>
	                            <li><a href="../classes/UAConditionBase.html">UAConditionBase</a></li>
	                            <li><a href="../classes/UADataType.html">UADataType</a></li>
	                            <li><a href="../classes/UADiscreteAlarm.html">UADiscreteAlarm</a></li>
	                            <li><a href="../classes/UAExclusiveDeviationAlarm.html">UAExclusiveDeviationAlarm</a></li>
	                            <li><a href="../classes/UAExclusiveLevelAlarm.html">UAExclusiveLevelAlarm</a></li>
	                            <li><a href="../classes/UAExclusiveLimitAlarm.html">UAExclusiveLimitAlarm</a></li>
	                            <li><a href="../classes/UAExclusiveRateOfChangeAlarm.html">UAExclusiveRateOfChangeAlarm</a></li>
	                            <li><a href="../classes/UALimitAlarm.html">UALimitAlarm</a></li>
	                            <li><a href="../classes/UANonExclusiveDeviationAlarm.html">UANonExclusiveDeviationAlarm</a></li>
	                            <li><a href="../classes/UANonExclusiveLimitAlarm.html">UANonExclusiveLimitAlarm</a></li>
	                            <li><a href="../classes/UAObject.html">UAObject</a></li>
	                            <li><a href="../classes/UAObjectType.html">UAObjectType</a></li>
	                            <li><a href="../classes/UAOffNormalAlarm.html">UAOffNormalAlarm</a></li>
	                            <li><a href="../classes/UASystemOffNormalAlarm.html">UASystemOffNormalAlarm</a></li>
	                            <li><a href="../classes/UATripAlarm.html">UATripAlarm</a></li>
	                            <li><a href="../classes/UATwoStateVariable.html">UATwoStateVariable</a></li>
	                            <li><a href="../classes/UAVariable.html">UAVariable</a></li>
	                            <li><a href="../classes/UAVariableType.html">UAVariableType</a></li>
	                            <li><a href="../classes/UnregisterNodesRequest.html">UnregisterNodesRequest</a></li>
	                            <li><a href="../classes/UnregisterNodesResponse.html">UnregisterNodesResponse</a></li>
	                            <li><a href="../classes/UserNameIdentityToken.html">UserNameIdentityToken</a></li>
	                            <li><a href="../classes/UserTokenPolicy.html">UserTokenPolicy</a></li>
	                            <li><a href="../classes/Variant.html">Variant</a></li>
	                            <li><a href="../classes/View.html">View</a></li>
	                            <li><a href="../classes/ViewDescription.html">ViewDescription</a></li>
	                            <li><a href="../classes/WriteRequest.html">WriteRequest</a></li>
	                            <li><a href="../classes/WriteResponse.html">WriteResponse</a></li>
	                            <li><a href="../classes/WriteValue.html">WriteValue</a></li>
	                            <li><a href="../classes/X509IdentityToken.html">X509IdentityToken</a></li>
	                            <li><a href="../classes/Xml2Json.html">Xml2Json</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                            <li><a href="../modules/opcua.address_space.html">opcua.address_space</a></li>
	                            <li><a href="../modules/opcua.address_space.AlarmsAndConditions.html">opcua.address_space.AlarmsAndConditions</a></li>
	                            <li><a href="../modules/opcua.address_space.types.html">opcua.address_space.types</a></li>
	                            <li><a href="../modules/opcua.client.html">opcua.client</a></li>
	                            <li><a href="../modules/opcua.data-value.html">opcua.data-value</a></li>
	                            <li><a href="../modules/opcua.datamodel.html">opcua.datamodel</a></li>
	                            <li><a href="../modules/opcua.miscellaneous.html">opcua.miscellaneous</a></li>
	                            <li><a href="../modules/opcua.server.html">opcua.server</a></li>
	                            <li><a href="../modules/opcua.server.simulation.html">opcua.server.simulation</a></li>
	                            <li><a href="../modules/opcua.status-code.html">opcua.status-code</a></li>
	                            <li><a href="../modules/opcua.transport.html">opcua.transport</a></li>
	                            <li><a href="../modules/opcua.utils.html">opcua.utils</a></li>
	                            <li><a href="../modules/opcua.variant.html">opcua.variant</a></li>
	                            <li><a href="../modules/service.filter.tools.html">service.filter.tools</a></li>
	                            <li><a href="../modules/services.browse.html">services.browse</a></li>
	                            <li><a href="../modules/services.call.html">services.call</a></li>
	                            <li><a href="../modules/services.discovery.html">services.discovery</a></li>
	                            <li><a href="../modules/services.endpoints.html">services.endpoints</a></li>
	                            <li><a href="../modules/services.filter.html">services.filter</a></li>
	                            <li><a href="../modules/services.history.html">services.history</a></li>
	                            <li><a href="../modules/services.node_management.html">services.node_management</a></li>
	                            <li><a href="../modules/services.query.html">services.query</a></li>
	                            <li><a href="../modules/services.read.html">services.read</a></li>
	                            <li><a href="../modules/services.register-server.html">services.register-server</a></li>
	                            <li><a href="../modules/services.register_node.html">services.register_node</a></li>
	                            <li><a href="../modules/services.secure-channel.html">services.secure-channel</a></li>
	                            <li><a href="../modules/services.session.html">services.session</a></li>
	                            <li><a href="../modules/services.subscription.html">services.subscription</a></li>
	                            <li><a href="../modules/services.translate-browse-path.html">services.translate-browse-path</a></li>
	                            <li><a href="../modules/services.write.html">services.write</a></li>
	                            <li><a href="../modules/StatusCodes.html">StatusCodes</a></li>
	                            <li><a href="../modules/xml2json
	    
	    node -&gt; see if https:__github.com_isaacs_sax-js could be used instead.html">xml2json
	    
	    node -&gt; see if https://github.com/isaacs/sax-js could be used instead</a></li>
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>packages/node-opcua-server/src/subscription.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
&quot;use strict&quot;;
/**
 * @module opcua.server
 */


var Dequeue = require(&quot;dequeue&quot;);

var subscription_service = require(&quot;node-opcua-service-subscription&quot;);
var DataChangeNotification = subscription_service.DataChangeNotification;
var EventNotificationList = subscription_service.EventNotificationList;
var NotificationMessage = subscription_service.NotificationMessage;
var StatusChangeNotification = subscription_service.StatusChangeNotification;
var MonitoringMode = subscription_service.MonitoringMode;

var StatusCodes = require(&quot;node-opcua-status-code&quot;).StatusCodes;
var Enum = require(&quot;node-opcua-enum&quot;);
var assert = require(&quot;node-opcua-assert&quot;);
var _ = require(&quot;underscore&quot;);

var AttributeIds = require(&quot;node-opcua-data-model&quot;).AttributeIds;

var SequenceNumberGenerator = require(&quot;node-opcua-secure-channel&quot;).SequenceNumberGenerator;

var EventEmitter = require(&quot;events&quot;).EventEmitter;
var util = require(&quot;util&quot;);

var SessionContext = require(&quot;node-opcua-address-space&quot;).SessionContext;

var EventFilter = require(&quot;node-opcua-service-filter&quot;).EventFilter;
var DataChangeFilter = require(&quot;node-opcua-service-subscription&quot;).DataChangeFilter;
var AggregateFilter = require(&quot;node-opcua-service-subscription&quot;).AggregateFilter;

var UAVariable = require(&quot;node-opcua-address-space&quot;).UAVariable;
var validateFilter  = require(&quot;./validate_filter&quot;).validateFilter;
var is_valid_dataEncoding = require(&quot;node-opcua-data-model&quot;).is_valid_dataEncoding;

var debugLog = require(&quot;node-opcua-debug&quot;).make_debugLog(__filename);
var doDebug = require(&quot;node-opcua-debug&quot;).checkDebugFlag(__filename);

var SubscriptionState = new Enum([
    &quot;CLOSED&quot;,   // The Subscription has not yet been created or has terminated.
    &quot;CREATING&quot;, // The Subscription is being created
    &quot;NORMAL&quot;,   // The Subscription is cyclically checking for Notifications from its MonitoredItems.
                // The keep-alive counter is not used in this state.
    &quot;LATE&quot;,     // The publishing timer has expired and there are Notifications available or a keep-alive Message is
                // ready to be sent, but there are no Publish requests queued. When in this state, the next Publish
                // request is processed when it is received. The keep-alive counter is not used in this state.
    &quot;KEEPALIVE&quot;,// The Subscription is cyclically checking for Notification
                // alive counter to count down to 0 from its maximum.
    &quot;TERMINATED&quot;
]);
exports.SubscriptionState = SubscriptionState;


var SubscriptionDiagnostics = require(&quot;node-opcua-common&quot;).SubscriptionDiagnostics;

var minimumPublishingInterval = 100;  // fastest possible
var defaultPublishingInterval = 100;
var maximumPublishingInterval = 1000 * 60 * 60 * 24 * 30; // 1 month

function _adjust_publishing_interval(publishingInterval) {
    publishingInterval = publishingInterval || defaultPublishingInterval;
    publishingInterval = Math.max(publishingInterval, minimumPublishingInterval);
    publishingInterval = Math.min(publishingInterval, maximumPublishingInterval);
    return publishingInterval;
}

var minimumMaxKeepAliveCount = 2;
var maximumMaxKeepAliveCount = 12000;
function _adjust_maxKeepAliveCount(maxKeepAliveCount/*,publishingInterval*/) {
    maxKeepAliveCount = maxKeepAliveCount || minimumMaxKeepAliveCount;
    maxKeepAliveCount = Math.max(maxKeepAliveCount, minimumMaxKeepAliveCount);
    maxKeepAliveCount = Math.min(maxKeepAliveCount, maximumMaxKeepAliveCount);
    return maxKeepAliveCount;
}
function _adjust_lifeTimeCount(lifeTimeCount, maxKeepAliveCount,publishingInterval) {
    lifeTimeCount = lifeTimeCount || 1;

    // let&#x27;s make sure that lifeTimeCount is at least three time maxKeepAliveCount
    // Note : the specs say ( part 3  - CreateSubscriptionParameter )
    //        &quot;The lifetime count shall be a minimum of three times the keep keep-alive count.&quot;
    lifeTimeCount = Math.max(lifeTimeCount, maxKeepAliveCount * 3 );

    var minTicks = Math.ceil(10 *1000 / (publishingInterval)); // we want 10 seconds moin

    lifeTimeCount = Math.max(minTicks,lifeTimeCount);
    return lifeTimeCount;
}

function _adjust_publishinEnable(publishingEnabled) {
    return (publishingEnabled === null || publishingEnabled === undefined) ? true : !!publishingEnabled;
}

function _adjust_maxNotificationsPerPublish(maxNotificationsPerPublish) {
    maxNotificationsPerPublish += 0;
    assert(_.isNumber(maxNotificationsPerPublish));
    return (maxNotificationsPerPublish &gt;= 0) ? maxNotificationsPerPublish : 0;
}
// verify that the injected publishEngine provides the expected services
// regarding the Subscription requirements...
function _assert_valid_publish_engine(publishEngine) {
    assert(_.isObject(publishEngine));
    assert(_.isNumber(publishEngine.pendingPublishRequestCount));
    assert(_.isFunction(publishEngine.send_notification_message));
    assert(_.isFunction(publishEngine.send_keep_alive_response));
    assert(_.isFunction(publishEngine.on_close_subscription));
}


function createSubscriptionDiagnostics(self) {

    self.subscriptionDiagnostics = new SubscriptionDiagnostics({});

    // &quot;sessionId&quot;
    self.subscriptionDiagnostics.__defineGetter__(&quot;sessionId&quot;,                  function() { return self.getSessionId(); });
    self.subscriptionDiagnostics.__defineGetter__(&quot;subscriptionId&quot;,             function() { return self.id; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;priority&quot;,                   function() { return self.priority; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;publishingInterval&quot;,         function() { return self.publishingInterval; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;maxLifetimeCount&quot;,           function() { return self.lifeTimeCount; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;maxKeepAliveCount&quot;,          function() { return self.maxKeepAliveCount; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;maxNotificationsPerPublish&quot;, function() { return self.maxNotificationsPerPublish; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;publishingEnabled&quot;,          function() { return self.publishingEnabled; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;monitoredItemCount&quot;,         function() { return self.monitoredItemCount; });
    self.subscriptionDiagnostics.__defineGetter__(&quot;nextSequenceNumber&quot;,         function() { return self._get_future_sequence_number(); });
    self.subscriptionDiagnostics.__defineGetter__(&quot;disabledMonitoredItemCount&quot;, function() { return self.disabledMonitoredItemCount; });

    /* those member of self.subscriptionDiagnostics are handled directly

     modifyCount
     enableCount,
     disableCount,
     republishRequestCount,
     notificationsCount,
     publishRequestCount,
     dataChangeNotificationsCount,
     eventNotificationsCount,
    */

    /*
     those members are not updated yet in the code :
     &quot;republishMessageRequestCount&quot;,
     &quot;republishMessageCount&quot;,
     &quot;transferRequestCount&quot;,
     &quot;transferredToAltClientCount&quot;,
     &quot;transferredToSameClientCount&quot;,
     &quot;latePublishRequestCount&quot;,
     &quot;currentKeepAliveCount&quot;,
     &quot;currentLifetimeCount&quot;,
     &quot;unacknowledgedMessageCount&quot;,
     &quot;discardedMessageCount&quot;,
     &quot;monitoringQueueOverflowCount&quot;,
     &quot;eventQueueOverFlowCount&quot;
     */
    // add object in Variable SubscriptionDiagnosticArray (i=2290) ( Array of SubscriptionDiagnostics)
    // add properties in Variable to reflect
}
/**
 * The Subscription class used in the OPCUA server side.
 * @class Subscription
 * @param {Object} options
 * @param options.id {Integer} - a unique identifier
 * @param options.publishingInterval {Integer} - [optional](default:1000) the publishing interval.
 * @param options.maxKeepAliveCount  {Integer} - [optional](default:10) the max KeepAlive Count.
 * @param options.lifeTimeCount      {Integer} - [optional](default:10) the max Life Time Count
 * @param options.publishingEnabled  {Boolean} - [optional](default:true)
 * @param options.sessionId          {NodeId}  - [optional]
 * @param options.maxNotificationsPerPublish {Integer} - [optional](default:0)
 * @param options.priority {Byte}
 * @constructor
 */
function Subscription(options) {

    options = options || {};

    EventEmitter.apply(this, arguments);
    var self = this;

    self._sessionId = options.sessionId;

    self.publishEngine = options.publishEngine;
    _assert_valid_publish_engine(self.publishEngine);

    self.id = options.id || &quot;&lt;invalid_id&gt;&quot;;

    self.priority = options.priority || 0;


    /**
     * the Subscription publishing interval
     * @property  publishingInterval
     * @type {number}
     * @default 1000
     */
    self.publishingInterval = _adjust_publishing_interval(options.publishingInterval);

    /**
     * The keep alive count defines how many times the publish interval need to
     * expires without having notifications available before the server send an
     * empty message.
     * OPCUA Spec says: a value of 0 is invalid.
     * @property  maxKeepAliveCount
     * @type {number}
     * @default 10
     *
     */
    self.maxKeepAliveCount = _adjust_maxKeepAliveCount(options.maxKeepAliveCount,self.publishingInterval);

    self.resetKeepAliveCounter();

    /**
     * The life time count defines how many times the publish interval expires without
     * having a connection to the client to deliver data.
     * If the life time count reaches maxKeepAliveCount, the subscription will
     * automatically terminate.
     * OPCUA Spec: The life-time count shall be a minimum of three times the keep keep-alive count.
     *
     * Note: this has to be interpreted as without having a PublishRequest available
     * @property  lifeTimeCount
     * @type {Number}
     * @default 1
     */
    self.lifeTimeCount = _adjust_lifeTimeCount(options.lifeTimeCount, self.maxKeepAliveCount,self.publishingInterval);


    /**
     * The maximum number of notifications that the Client wishes to receive in a
     * single Publish response. A value of zero indicates that there is no limit.
     * The number of notifications per Publish is the sum of monitoredItems in the
     * DataChangeNotification and events in the EventNotificationList.
     *
     * @property maxNotificationsPerPublish
     * @type {Number}
     * #default 0
     */
    self.maxNotificationsPerPublish = _adjust_maxNotificationsPerPublish(options.maxNotificationsPerPublish);

    self._life_time_counter = 0;
    self.resetLifeTimeCounter();

    // notification message that are ready to be sent to the client
    self._pending_notifications = new Dequeue();

    self._sent_notifications = [];

    self._sequence_number_generator = new SequenceNumberGenerator();

    // initial state of the subscription
    self.state = SubscriptionState.CREATING;

    self.publishIntervalCount = 0;

    self.monitoredItems = {}; // monitored item map

    /**
     *  number of monitored Item
     *  @property monitoredItemIdCounter
     *  @type {Number}
     */
    self.monitoredItemIdCounter = 0;

    self.publishingEnabled = _adjust_publishinEnable(options.publishingEnabled);

    createSubscriptionDiagnostics(self);

    // A boolean value that is set to TRUE to mean that either a NotificationMessage or a keep-alive Message has been
    // sent on the Subscription. It is a flag that is used to ensure that either a NotificationMessage or a keep-alive
    // Message is sent out the first time the publishing timer expires.
    self.messageSent = false;

    self._unacknowledgedMessageCount = 0;
    
    self.timerId = null;
    self._start_timer();

}

util.inherits(Subscription, EventEmitter);

var ObjectRegistry = require(&quot;node-opcua-object-registry&quot;).ObjectRegistry;
Subscription.registry = new ObjectRegistry();

Subscription.prototype.getSessionId = function () {
    var self = this;
    return self._sessionId;
};

Subscription.prototype.toString = function () {

    var self = this;
    var str = &quot;&quot;;
    str += &quot;  publishingEnabled  &quot; + self.publishingEnabled + &quot;\n&quot;;
    str += &quot;  maxKeepAliveCount  &quot; + self.maxKeepAliveCount + &quot;\n&quot;;
    str += &quot;  publishingInterval &quot; + self.publishingInterval + &quot;\n&quot;;
    str += &quot;  lifeTimeCount      &quot; + self.lifeTimeCount + &quot;\n&quot;;
    str += &quot;  maxKeepAliveCount  &quot; + self.maxKeepAliveCount + &quot;\n&quot;;
    return str;
};

/**
 * @method modify
 * @param param {Object}
 * @param param.requestedPublishingInterval  {Duration}  requestedPublishingInterval =0 means fastest possible
 * @param param.requestedLifetimeCount       {Counter}   requestedLifetimeCount      ===0 means no change
 * @param param.requestedMaxKeepAliveCount   {Counter}   requestedMaxKeepAliveCount  ===0 means no change
 * @param param.maxNotificationsPerPublish   {Counter}
 * @param param.priority                     {Byte}
 *
 */
Subscription.prototype.modify = function (param) {
    var self = this;

    // update diagnostic counter
    self.subscriptionDiagnostics.modifyCount +=1;

    var publishingInterval_old = self.publishingInterval;

    param.requestedPublishingInterval = param.requestedPublishingInterval || 0;
    param.requestedMaxKeepAliveCount = param.requestedMaxKeepAliveCount || self.maxKeepAliveCount;
    param.requestedLifetimeCount = param.requestedLifetimeCount || self.lifeTimeCount;

    self.publishingInterval = _adjust_publishing_interval(param.requestedPublishingInterval);
    self.maxKeepAliveCount = _adjust_maxKeepAliveCount(param.requestedMaxKeepAliveCount,self.publishingInterval);
    self.lifeTimeCount = _adjust_lifeTimeCount(param.requestedLifetimeCount, self.maxKeepAliveCount,self.publishingInterval);

    self.maxNotificationsPerPublish = param.maxNotificationsPerPublish;
    self.priority = param.priority;

    self.resetLifeTimeAndKeepAliveCounters();

    if (publishingInterval_old !== self.publishingInterval) {
        // todo
    }
    self._stop_timer();
    self._start_timer();

};

Subscription.prototype._stop_timer = function () {
    var self = this;
    if (self.timerId) {
        debugLog(&quot;Subscription#_stop_timer subscriptionId=&quot;.bgWhite.blue,self.id);
        clearInterval(self.timerId);
        self.timerId = null;
        Subscription.registry.unregister(self);
    }
};


Subscription.prototype._start_timer = function () {

    var self = this;
    debugLog(&quot;Subscription#_start_timer  subscriptionId=&quot;.bgWhite.blue,self.id,&quot; publishingInterval = &quot;,self.publishingInterval);

    assert(self.timerId === null);
    // from the spec:
    // When a Subscription is created, the first Message is sent at the end of the first publishing cycle to
    // inform the Client that the Subscription is operational. A NotificationMessage is sent if there are
    // Notifications ready to be reported. If there are none, a keep-alive Message is sent instead that
    // contains a sequence number of 1, indicating that the first NotificationMessage has not yet been sent.
    // This is the only time a keep-alive Message is sent without waiting for the maximum keep-alive count
    // to be reached, as specified in (f) above.


    // make sure that a keep-alive Message will be send at the end of the first publishing cycle
    // if there are no Notifications ready.
    self._keep_alive_counter = self.maxKeepAliveCount;

    assert(self.publishingInterval &gt;= minimumPublishingInterval);
    self.timerId = setInterval(self._tick.bind(self), self.publishingInterval);

    Subscription.registry.register(self);

};

// counter
Subscription.prototype._get_next_sequence_number = function () {
    return this._sequence_number_generator.next();
};

// counter
Subscription.prototype._get_future_sequence_number = function () {
    return this._sequence_number_generator.future();
};


Subscription.prototype.setPublishingMode = function (publishingEnabled) {

    this.publishingEnabled = !!publishingEnabled;

    // update diagnostics

    if (this.publishingEnabled) {
        this.subscriptionDiagnostics.enableCount += 1;
    } else {
        this.subscriptionDiagnostics.disableCount += 1;
    }

    this.resetLifeTimeCounter();

    if (!publishingEnabled  &amp;&amp; this.state !== SubscriptionState.CLOSED) {
        this.state = SubscriptionState.NORMAL;
    }
    return StatusCodes.Good;
};


/**
 *  _publish_pending_notifications send a &quot;notification&quot; event:
 *
 * @method _publish_pending_notifications *
 * @private
 *
 */
Subscription.prototype._publish_pending_notifications = function () {

    var self = this;
    var publishEngine = self.publishEngine;
    var subscriptionId = self.id;

    // preconditions
    assert(publishEngine.pendingPublishRequestCount &gt; 0);
    assert(self.hasPendingNotifications);

    function _count_notification_message(notifData) {

        if (notifData instanceof DataChangeNotification) {
            self.subscriptionDiagnostics.dataChangeNotificationsCount += 1;
        } else if (notifData instanceof EventNotificationList) {
            self.subscriptionDiagnostics.eventNotificationsCount += 1;
        } else {
            // TODO
        }
    }

    // todo : get rid of this....
    self.emit(&quot;notification&quot;);

    var notificationMessage = self._popNotificationToSend().notification;

    self.emit(&quot;notificationMessage&quot;,notificationMessage);


    assert(_.isArray(notificationMessage.notificationData));

    notificationMessage.notificationData.forEach(_count_notification_message);


    assert(notificationMessage.hasOwnProperty(&quot;sequenceNumber&quot;));
    assert(notificationMessage.hasOwnProperty(&quot;notificationData&quot;));

    var moreNotifications = (self.hasPendingNotifications);

    // update diagnostics
    if(self.subscriptionDiagnostics) {
        self.subscriptionDiagnostics.notificationsCount += 1;
        self.subscriptionDiagnostics.publishRequestCount += 1;
    }

    publishEngine.send_notification_message({
        subscriptionId: subscriptionId,
        sequenceNumber: notificationMessage.sequenceNumber,
        notificationData: notificationMessage.notificationData,
        moreNotifications: moreNotifications
    },false);
    self.messageSent = true;
    self._unacknowledgedMessageCount ++;
    
    self.resetLifeTimeAndKeepAliveCounters();

    if (doDebug) {
        debugLog(&quot;Subscription sending a notificationMessage subscriptionId=&quot;, subscriptionId,
            &quot;sequenceNumber = &quot;,notificationMessage.sequenceNumber.toString());
        // debugLog(notificationMessage.toString());
    }

    if (self.state !== SubscriptionState.CLOSED) {
        assert(notificationMessage.notificationData.length &gt;0, &quot;We are not expecting a keep-alive message here&quot;);
        self.state = SubscriptionState.NORMAL;
        debugLog(&quot;subscription &quot; + self.id + &quot; set to NORMAL&quot;.bgYellow);
    }

};

Subscription.prototype._process_keepAlive = function () {
    var self = this;

    //xx assert(!self.publishingEnabled || (!self.hasPendingNotifications &amp;&amp; !self.hasMonitoredItemNotifications));

    self.increaseKeepAliveCounter();

    if (self.keepAliveCounterHasExpired) {

        if (self._sendKeepAliveResponse()) {

            self.resetLifeTimeAndKeepAliveCounters();

        } else {
            debugLog(&quot;     -&gt; subscription.state === LATE , because keepAlive Response cannot be send due to lack of PublishRequest&quot;);
            self.state = SubscriptionState.LATE;
        }
    }
};



Subscription.prototype.process_subscription = function () {

    var self = this;

    assert(self.publishEngine.pendingPublishRequestCount &gt;0);

    if (!self.publishingEnabled) {
        // no publish to do, except keep alive
        self._process_keepAlive();
        return;
    }

    if( !self.hasPendingNotifications &amp;&amp; self.hasMonitoredItemNotifications) {
        // collect notification from monitored items
        self._harvestMonitoredItems();
    }

    // let process them first
    if (self.hasPendingNotifications) {

        self._publish_pending_notifications();

        if (self.state === SubscriptionState.NORMAL &amp;&amp; self.hasPendingNotifications) {

            // istanbul ignore next
            if (doDebug) {
                debugLog(&quot;    -&gt; pendingPublishRequestCount &gt; 0 &amp;&amp; normal state =&gt; re-trigger tick event immediately &quot;);
            }

            // let process an new publish request
            setImmediate(self._tick.bind(self));
        }

    } else {
        self._process_keepAlive();
    }
};

function w(s, w) {
    return (&quot;000&quot; + s).substr(-w);
}
function t(d) {
    return w(d.getHours(), 2) + &quot;:&quot; + w(d.getMinutes(), 2) + &quot;:&quot; + w(d.getSeconds(), 2) + &quot;:&quot; + w(d.getMilliseconds(), 3);
}
/**
 * @method _tick
 * @private
 */
Subscription.prototype._tick = function () {

    var self = this;

    self.discardOldSentNotifications();

    // istanbul ignore next
    if (doDebug) {
        debugLog((t(new Date()) + &quot;  &quot; + self._life_time_counter + &quot;/&quot;  + self.lifeTimeCount + &quot;   Subscription#_tick&quot;).cyan,&quot;  processing subscriptionId=&quot;, self.id, &quot;hasMonitoredItemNotifications = &quot;,self.hasMonitoredItemNotifications,&quot; publishingIntervalCount =&quot;,self.publishIntervalCount);
    }
    if (self.publishEngine._on_tick) {
        self.publishEngine._on_tick();
    }

    self.publishIntervalCount += 1;

    self.increaseLifeTimeCounter();

    if (self.lifeTimeHasExpired) {

        /* istanbul ignore next */
        if (doDebug) {
            debugLog(&quot;Subscription &quot; + self.id + &quot; has expired !!!!! =&gt; Terminating&quot;.red.bold);
        }
        /**
         * notify the subscription owner that the subscription has expired by exceeding its life time.
         * @event expired
         *
         */
        self.emit(&quot;expired&quot;);

        // notify new terminated status only when subscription has timeout.
        debugLog(&quot;adding StatusChangeNotification notification message for BadTimeout subscription = &quot;, self.id);
        self._addNotificationMessage([new StatusChangeNotification({statusCode: StatusCodes.BadTimeout})]);

        // kill timer and delete monitored items
        self.terminate();

        return;

    }

    var publishEngine = self.publishEngine;

    // istanbul ignore next
    if(doDebug) { debugLog(&quot;Subscription#_tick  self._pending_notifications= &quot;,self._pending_notifications.length);}

    if (publishEngine.pendingPublishRequestCount === 0 &amp;&amp; ( self.hasPendingNotifications || self.hasMonitoredItemNotifications) ) {

        // istanbul ignore next
        if (doDebug) {
            debugLog(&quot;subscription set to LATE  hasPendingNotifications = &quot;,self.hasPendingNotifications,&quot; hasMonitoredItemNotifications =&quot;,self.hasMonitoredItemNotifications);
        }
        self.state = SubscriptionState.LATE;
        return;
    }

    if (publishEngine.pendingPublishRequestCount &gt; 0 ) {

        if (self.hasPendingNotifications) {
            // simply pop pending notification and send it
            self.process_subscription();

        } else if (self.hasMonitoredItemNotifications) {
            self.process_subscription();

        } else {
            self._process_keepAlive();
        }
    } else {
        self._process_keepAlive();
    }
};


/**
 * @method _sendKeepAliveResponse
 * @private
 */
Subscription.prototype._sendKeepAliveResponse = function () {

    var self = this;
    var future_sequence_number = self._get_future_sequence_number();

    debugLog(&quot;     -&gt; Subscription#_sendKeepAliveResponse subscriptionId&quot;,self.id);

    if (self.publishEngine.send_keep_alive_response(self.id, future_sequence_number)) {

        self.messageSent = true;

        /**
         * notify the subscription owner that a keepalive message has to be sent.
         * @event keepalive
         *
         */
        self.emit(&quot;keepalive&quot;, future_sequence_number);
        self.state = SubscriptionState.KEEPALIVE;

        return true;
    }
    return false;
};


/**
 * @method resetKeepAliveCounter
 * @private
 * Reset the Lifetime Counter Variable to the value specified for the lifetime of a Subscription in
 * the CreateSubscription Service( 5.13.2).
 */
Subscription.prototype.resetKeepAliveCounter = function () {
    var self = this;
    self._keep_alive_counter = 0;

    // istanbul ignore next
    if (doDebug) {
        debugLog(&quot;     -&gt; subscriptionId&quot;,self.id,&quot; Resetting keepAliveCounter = &quot;,self._keep_alive_counter,self.maxKeepAliveCount);
    }
};

/**
 * @method increaseKeepAliveCounter
 * @private
 */
Subscription.prototype.increaseKeepAliveCounter = function () {
    var self = this;
    self._keep_alive_counter += 1;

    // istanbul ignore next
    if (doDebug) {
        debugLog(&quot;     -&gt; subscriptionId&quot;,self.id,&quot; Increasing keepAliveCounter = &quot;, self._keep_alive_counter, self.maxKeepAliveCount);
    }
};

/**
 * @property keepAliveCounterHasExpired
 * @private
 * @type {Boolean} true if the keep alive counter has reach its limit.
 */
Subscription.prototype.__defineGetter__(&quot;keepAliveCounterHasExpired&quot;, function () {
    var self = this;
    return self._keep_alive_counter &gt;= self.maxKeepAliveCount;
});


/**
 * Reset the Lifetime Counter Variable to the value specified for the lifetime of a Subscription in
 * the CreateSubscription Service( 5.13.2).
 * @method resetLifeTimeCounter
 * @private
 */
Subscription.prototype.resetLifeTimeCounter = function () {
    var self = this;
    self._life_time_counter = 0;
};
/**
 * @method increaseLifeTimeCounter
 * @private
 */
Subscription.prototype.increaseLifeTimeCounter = function () {
    var self = this;
    self._life_time_counter += 1;
};

/**
 *  True if the subscription life time has expired.
 *
 * @property lifeTimeHasExpired
 * @type {boolean} - true if the subscription life time has expired.
 */
Subscription.prototype.__defineGetter__(&quot;lifeTimeHasExpired&quot;, function () {
    var self = this;
    assert(self.lifeTimeCount &gt; 0);
    return self._life_time_counter &gt;= self.lifeTimeCount;
});

/**
 * number of milliseconds before this subscription times out (lifeTimeHasExpired === true);
 * @property timeToExpiration
 * @type {Number}
 */
Subscription.prototype.__defineGetter__(&quot;timeToExpiration&quot;, function () {
    var self = this;
    return (self.lifeTimeCount - self._life_time_counter ) * self.publishingInterval;
});

Subscription.prototype.__defineGetter__(&quot;timeToKeepAlive&quot;, function () {
    var self = this;
    return (self.maxKeepAliveCount - self._keep_alive_counter ) * self.publishingInterval;
});

/**
 *
 *  the server invokes the resetLifeTimeAndKeepAliveCounters method of the subscription
 *  when the server  has send a Publish Response, so that the subscription
 *  can reset its life time counter.
 *
 * @method resetLifeTimeAndKeepAliveCounters
 *
 */
Subscription.prototype.resetLifeTimeAndKeepAliveCounters = function () {
    var self = this;
    self.resetLifeTimeCounter();
    self.resetKeepAliveCounter();
};

/**
 * Terminates the subscription.
 * @method terminate
 *
 * Calling this method will also remove any monitored items.
 *
 */
Subscription.prototype.terminate = function () {
    var self = this;

    if (self.state === SubscriptionState.CLOSED) {
        // todo verify if asserting is required here
        return;
    }
    assert(self.state !== SubscriptionState.CLOSED, &quot;terminate already called ?&quot;);

    // stop timer
    self._stop_timer();

    debugLog(&quot;terminating Subscription  &quot;, self.id, &quot; with &quot;, self.monitoredItemCount, &quot; monitored items&quot;);

    // dispose all monitoredItem
    var keys = Object.keys(self.monitoredItems);

    keys.forEach(function (key) {
        var status = self.removeMonitoredItem(key);
        assert(status === StatusCodes.Good);
    });

    assert(self.monitoredItemCount === 0);


    self.state = SubscriptionState.CLOSED;

    self.publishEngine.on_close_subscription(self);

    /**
     * notify the subscription owner that the subscription has been terminated.
     * @event &quot;terminated&quot;
     */
    self.emit(&quot;terminated&quot;);
};

function assert_validNotificationData(n) {
    assert(
        n instanceof DataChangeNotification ||
        n instanceof EventNotificationList  ||
        n instanceof StatusChangeNotification
    );
}

/**
 * @method _addNotificationMessage
 * @param notificationData {Array&lt;DataChangeNotification|EventNotificationList|StatusChangeNotification&gt;}
 */
Subscription.prototype._addNotificationMessage = function (notificationData) {

    assert(_.isArray(notificationData));
    assert(notificationData.length === 1 || notificationData.length === 2); // as per spec part 3.

    // istanbul ignore next
    if (false &amp;&amp; doDebug) {
        debugLog(&quot;Subscription#_addNotificationMessage&quot;.yellow,notificationData.toString());
    }
    var self = this;
    assert(_.isObject(notificationData[0]));

    assert_validNotificationData(notificationData[0]);
    if (notificationData.length === 2) {
        assert_validNotificationData(notificationData[1]);
    }

    var notification_message = new NotificationMessage({
        sequenceNumber: self._get_next_sequence_number(),
        publishTime: new Date(),
        notificationData: notificationData
    });

    self._pending_notifications.push({
        notification: notification_message,
        start_tick: self.publishIntervalCount,
        publishTime: new Date(),
        sequenceNumber: notification_message.sequenceNumber
    });

};


Subscription.prototype.getMessageForSequenceNumber = function (sequenceNumber) {

    var self = this;

    function filter_func(e) {
        return e.sequenceNumber === sequenceNumber;
    }

    var notification_message = _.find(self._sent_notifications, filter_func);

    if (!notification_message) {
        return null;
    }
    return notification_message;

};

/**
 * Extract the next Notification that is ready to be sent to the client.
 * @method _popNotificationToSend
 * @return {NotificationMessage}  the Notification to send._pending_notifications
 */
Subscription.prototype._popNotificationToSend = function () {
    var self = this;
    assert(self._pending_notifications.length &gt;0);
    var notification_message = self._pending_notifications.shift();
    self._sent_notifications.push(notification_message);
    return notification_message;
};

/**
 * returns true if the notification has expired
 * @method notificationHasExpired
 * @param notification
 * @return {boolean}
 */
Subscription.prototype.notificationHasExpired = function (notification) {
    var self = this;
    assert(notification.hasOwnProperty(&quot;start_tick&quot;));
    assert(_.isFinite(notification.start_tick + self.maxKeepAliveCount));
    return (notification.start_tick + self.maxKeepAliveCount) &lt; self.publishIntervalCount;
};

var maxNotificationMessagesInQueue = 100;
/**
 * discardOldSentNotification find all sent notification message that have expired keep-alive
 * and destroy them.
 * @method discardOldSentNotifications
 * @private
 *
 * Subscriptions maintain a retransmission queue of sent  NotificationMessages.
 * NotificationMessages are retained in this queue until they are acknowledged or until they have
 * been in the queue for a minimum of one keep-alive interval.
 *
 */
Subscription.prototype.discardOldSentNotifications = function () {

    var self = this;

    // Sessions maintain a retransmission queue of sent NotificationMessages. NotificationMessages
    // are retained in this queue until they are acknowledged. The Session shall maintain a
    // retransmission queue size of at least two times the number of Publish requests per Session the
    // Server supports.  Clients are required to acknowledge NotificationMessages as they are received. In the
    // case of a retransmission queue overflow, the oldest sent NotificationMessage gets deleted. If a
    // Subscription is transferred to another Session, the queued NotificationMessages for this
    // Subscription are moved from the old to the new Session.
    if (maxNotificationMessagesInQueue &lt;= self._sent_notifications.length) {
        debugLog(&quot;discardOldSentNotifications = &quot;,self._sent_notifications.length);
        self._sent_notifications.splice(self._sent_notifications.length - maxNotificationMessagesInQueue);
    }
    //
    //var arr = _.filter(self._sent_notifications,function(notification){
    //   return self.notificationHasExpired(notification);
    //});
    //var results = arr.map(function(notification){
    //    return self.acknowledgeNotification(notification.sequenceNumber);
    //});
    //xx return results;
};

function getSequenceNumbers(arr) {
    return arr.map(function (e) {
        return e.notification.sequenceNumber;
    });
}
/**
 *  returns in an array the sequence numbers of the notifications that haven&#x27;t been
 *  acknowledged yet.
 *
 *  @method getAvailableSequenceNumbers
 *  @return {Integer[]}
 *
 */
Subscription.prototype.getAvailableSequenceNumbers = function () {
    var self = this;
    var availableSequenceNumbers = getSequenceNumbers(self._sent_notifications);
    return availableSequenceNumbers;
};


/**
 * @method acknowledgeNotification
 * @param sequenceNumber {Number}
 * @return {StatusCode}
 */
Subscription.prototype.acknowledgeNotification = function (sequenceNumber) {
    var self = this;

    var foundIndex = -1;
    _.find(self._sent_notifications, function (e, index) {
        if (e.sequenceNumber === sequenceNumber) {
            foundIndex = index;
        }
    });
    if (foundIndex === -1) {
        if (doDebug) {
            debugLog(&quot;acknowledging sequence FAILED !!! &quot;.red, sequenceNumber.toString().cyan);
        }
        return StatusCodes.BadSequenceNumberUnknown;
    } else {
        if (doDebug) {
            debugLog(&quot;acknowledging sequence &quot;.yellow, sequenceNumber.toString().cyan);
        }
        self._sent_notifications.splice(foundIndex, 1);
        self._unacknowledgedMessageCount --;
        return StatusCodes.Good;
    }
};


/**
 *
 * @property pendingNotificationsCount  - number of pending notifications
 * @type {Number}
 */
Subscription.prototype.__defineGetter__(&quot;pendingNotificationsCount&quot;, function () {
    return this._pending_notifications.length;
});

/**
 * return True is there are pending notifications for this subscription. (i.e moreNotifications)
 *
 * @property hasPendingNotifications
 * @type {Boolean}
 */
Subscription.prototype.__defineGetter__(&quot;hasPendingNotifications&quot;, function () {
    var self = this;
    return self.pendingNotificationsCount &gt; 0;
});

/**
 * number of sent notifications
 * @property sentNotificationsCount
 * @type {Number}
 */
Subscription.prototype.__defineGetter__(&quot;sentNotificationsCount&quot;, function () {
    return this._sent_notifications.length;
});

/**
 * number of monitored items.
 * @property monitoredItemCount
 * @type {Number}
 */
Subscription.prototype.__defineGetter__(&quot;monitoredItemCount&quot;, function () {
    return Object.keys(this.monitoredItems).length;
});

/**
 * number of disabled monitored items.
 * @property disabledMonitoredItemCount
 * @type {Number}
 */
Subscription.prototype.__defineGetter__(&quot;disabledMonitoredItemCount&quot;, function () {

    return  _.reduce(_.values(this.monitoredItems),function(cumul,monitoredItem) {
        return cumul + ( (monitoredItem.monitoringMode === MonitoringMode.Disabled ) ? 1 : 0 );
    },0);

});

/**
 * The number of unacknowledged messages saved in the republish queue.
 * @property unacknowledgedMessageCount
 * @type {Number}
 */
Subscription.prototype.__defineGetter__(&quot;unacknowledgedMessageCount&quot;, function () {
    var self = this;
    return self._unacknowledgedMessageCount;
});



var MonitoredItem = require(&quot;./monitored_item&quot;).MonitoredItem;


var MonitoredItemCreateRequest = require(&quot;node-opcua-service-subscription&quot;).MonitoredItemCreateRequest;


/**
 * adjust monitored item sampling interval
 *  - an samplingInterval ===0 means that we use a event-base model ( no sampling)
 *  - otherwise the sampling is adjusted
 *
 * @method adjustSamplingInterval
 * @param samplingInterval
 * @param node
 * @return {number|*}
 * @private
 */
Subscription.prototype.adjustSamplingInterval = function (samplingInterval, node) {

    var self = this;

    if (samplingInterval &lt; 0) {
        // - The value -1 indicates that the default sampling interval defined by the publishing
        //   interval of the Subscription is requested.
        // - Any negative number is interpreted as -1.
        samplingInterval = self.publishingInterval;

    } else if (samplingInterval === 0 ) {

        // OPCUA 1.0.3 Part 4 - 5.12.1.2
        // The value 0 indicates that the Server should use the fastest practical rate.

        // The fastest supported sampling interval may be equal to 0, which indicates
        // that the data item is exception-based rather than being sampled at some period.
        // An exception-based model means that the underlying system does not require sampling and reports data changes.

        var dataValueSamplingInterval = node.readAttribute(SessionContext.defaultContext, AttributeIds.MinimumSamplingInterval);

        // TODO if attributeId === AttributeIds.Value : sampling interval required here
        if (dataValueSamplingInterval.statusCode === StatusCodes.Good) {
            // node provides a Minimum sampling interval ...
            samplingInterval = dataValueSamplingInterval.value.value;
            assert(samplingInterval &gt;=0 &amp;&amp; samplingInterval &lt;= MonitoredItem.maximumSamplingInterval);

            // note : at this stage, a samplingInterval===0 means that the data item is really exception-based

        }

    } else if (samplingInterval &lt; MonitoredItem.minimumSamplingInterval) {

        samplingInterval = MonitoredItem.minimumSamplingInterval;

    } else if (samplingInterval &gt; MonitoredItem.maximumSamplingInterval) {

        // If the requested samplingInterval is higher than the
        // maximum sampling interval supported by the Server, the maximum sampling
        // interval is returned.
        samplingInterval = MonitoredItem.maximumSamplingInterval;
    }

    var node_minimumSamplingInterval = (node &amp;&amp; node.minimumSamplingInterval) ? node.minimumSamplingInterval : 0;
    samplingInterval = Math.max(samplingInterval, node_minimumSamplingInterval);

    return samplingInterval;
};


var checkSelectClauses = require(&quot;node-opcua-address-space&quot;).checkSelectClauses;

function analyseEventFilterResult(node, eventFilter) {
    assert(eventFilter instanceof EventFilter);
    var selectClauseResults = checkSelectClauses(node, eventFilter.selectClauses);

    var whereClauseResult = new subscription_service.ContentFilterResult();

    return new subscription_service.EventFilterResult({
        selectClauseResults: selectClauseResults,
        selectClauseDiagnosticInfos: [],
        whereClauseResult: whereClauseResult
    });
}
function analyseDataChangeFilterResult(node, dataChangeFilter) {
    assert(dataChangeFilter instanceof subscription_service.DataChangeFilter);
    // the opcua specification doesn&#x27;t provide dataChangeFilterResult
    return null;
}
function analyseAggregateFilterResult(node, aggregateFilter) {
    assert(aggregateFilter instanceof subscription_service.AggregateFilter);
    return new subscription_service.AggregateFilterResult({});
}


function _process_filter(node, filter) {

    if (!filter) {
        return null;
    }

    if (filter instanceof EventFilter) {
        return analyseEventFilterResult(node, filter);
    } else if (filter instanceof DataChangeFilter) {
        return analyseDataChangeFilterResult(node, filter);
    } else if (filter instanceof AggregateFilter) {
        return analyseAggregateFilterResult(node, filter);
    }
    // istanbul ignore next
    throw new Error(&quot;invalid filter&quot;);
}


Subscription.prototype.createMonitoredItem = function (addressSpace, timestampsToReturn, monitoredItemCreateRequest) {

    var self = this;
    assert(addressSpace.constructor.name === &quot;AddressSpace&quot;);
    assert(monitoredItemCreateRequest instanceof MonitoredItemCreateRequest);


    function handle_error(statusCode) {
        return new subscription_service.MonitoredItemCreateResult({statusCode: statusCode});
    }

    var itemToMonitor = monitoredItemCreateRequest.itemToMonitor;

    var node = addressSpace.findNode(itemToMonitor.nodeId);
    if (!node) {
        return handle_error(StatusCodes.BadNodeIdUnknown);
    }


    if (itemToMonitor.attributeId === AttributeIds.Value &amp;&amp; !(node instanceof UAVariable)) {
        // AttributeIds.Value is only valid for monitoring value of UAVariables.
        return handle_error(StatusCodes.BadAttributeIdInvalid);
    }


    if (itemToMonitor.attributeId === AttributeIds.INVALID) {
        return handle_error(StatusCodes.BadAttributeIdInvalid);
    }

    if (!itemToMonitor.indexRange.isValid()) {
        return handle_error(StatusCodes.BadIndexRangeInvalid);
    }

    // check dataEncoding applies only on Values
    if (itemToMonitor.dataEncoding.name &amp;&amp; itemToMonitor.attributeId !== AttributeIds.Value) {
        return handle_error(StatusCodes.BadDataEncodingInvalid);
    }

    // check dataEncoding
    if (!is_valid_dataEncoding(itemToMonitor.dataEncoding)) {
        return handle_error(StatusCodes.BadDataEncodingUnsupported);
    }

    // check that item can be read by current user session

    // filter
    var requestedParameters = monitoredItemCreateRequest.requestedParameters;
    var filter = requestedParameters.filter;
    var statusCodeFilter = validateFilter(filter, itemToMonitor , node);
    if (statusCodeFilter !== StatusCodes.Good) {
        return handle_error(statusCodeFilter);
    }
    //xx var monitoringMode      = monitoredItemCreateRequest.monitoringMode; // Disabled, Sampling, Reporting
    //xx var requestedParameters = monitoredItemCreateRequest.requestedParameters;

    var monitoredItemCreateResult = self._createMonitoredItemStep2(timestampsToReturn, monitoredItemCreateRequest, node);

    assert(monitoredItemCreateResult.statusCode === StatusCodes.Good);

    var monitoredItem = self.getMonitoredItem(monitoredItemCreateResult.monitoredItemId);
    assert(monitoredItem);

    // TODO: fix old way to set node. !!!!
    monitoredItem.setNode(node);

    self.emit(&quot;monitoredItem&quot;, monitoredItem, itemToMonitor);

    self._createMonitoredItemStep3(monitoredItem,monitoredItemCreateRequest);

    return monitoredItemCreateResult;

};

var g_monitoredItemId =1;
function getNextMonitoredItemId() {
    return g_monitoredItemId++;
}
/**
 *
 * @method _createMonitoredItemStep2
 * @param timestampsToReturn
 * @param {MonitoredItemCreateRequest} monitoredItemCreateRequest - the parameters describing the monitored Item to create
 * @param node {BaseNode}
 * @return {subscription_service.MonitoredItemCreateResult}
 * @private
 */
Subscription.prototype._createMonitoredItemStep2 = function (timestampsToReturn, monitoredItemCreateRequest, node) {

    var self = this;

    // note : most of the parameter inconsistencies shall have been handled by the caller
    // any error here will raise an assert here

    assert(monitoredItemCreateRequest instanceof MonitoredItemCreateRequest);
    var itemToMonitor = monitoredItemCreateRequest.itemToMonitor;

    //xx check if attribute Id invalid (we only support Value or EventNotifier )
    //xx assert(itemToMonitor.attributeId !== AttributeIds.INVALID);

    self.monitoredItemIdCounter += 1;


    var monitoredItemId = getNextMonitoredItemId();

    var requestedParameters = monitoredItemCreateRequest.requestedParameters;

    // adjust requestedParameters.samplingInterval
    requestedParameters.samplingInterval = self.adjustSamplingInterval(requestedParameters.samplingInterval, node);

    // reincorporate monitoredItemId and itemToMonitor into the requestedParameters
    requestedParameters.monitoredItemId = monitoredItemId;
    requestedParameters.itemToMonitor = itemToMonitor;


    var monitoredItem = new MonitoredItem(requestedParameters);
    monitoredItem.timestampsToReturn = timestampsToReturn;
    monitoredItem.$subscription = self;

    assert(monitoredItem.monitoredItemId === monitoredItemId);
    self.monitoredItems[monitoredItemId] = monitoredItem;

    var filterResult = _process_filter(node, requestedParameters.filter);


    var monitoredItemCreateResult = new subscription_service.MonitoredItemCreateResult({
        statusCode: StatusCodes.Good,
        monitoredItemId: monitoredItemId,
        revisedSamplingInterval: monitoredItem.samplingInterval,
        revisedQueueSize: monitoredItem.queueSize,
        filterResult: filterResult
    });
    return monitoredItemCreateResult;
};


Subscription.prototype._createMonitoredItemStep3 = function (monitoredItem,monitoredItemCreateRequest) {

    assert(monitoredItem.monitoringMode === MonitoringMode.Invalid);
    assert(_.isFunction(monitoredItem.samplingFunc));
    var monitoringMode = monitoredItemCreateRequest.monitoringMode; // Disabled, Sampling, Reporting
    monitoredItem.setMonitoringMode(monitoringMode);

};

/**
 * get a monitoredItem by Id.
 * @method getMonitoredItem
 * @param monitoredItemId  {Number} the id of the monitored item to get.
 * @return {MonitoredItem}
 */
Subscription.prototype.getMonitoredItem = function (monitoredItemId) {
    assert(_.isFinite(monitoredItemId));
    var self = this;
    return self.monitoredItems[monitoredItemId];
};

/**
 * getMonitoredItems is used to get information about monitored items of a subscription.Its intended
 * use is defined in Part 4. This method is the implementation of the Standard OPCUA GetMonitoredItems Method.
 * @method getMonitoredItems
 * @param  result.serverHandles {Int32[]} Array of serverHandles for all MonitoredItems of the subscription identified by subscriptionId.
 *         result.clientHandles {Int32[]} Array of clientHandles for all MonitoredItems of the subscription identified by subscriptionId.
 *         result.statusCode    {StatusCode}
 * from spec:
 * This method can be used to get the  list of monitored items in a subscription if CreateMonitoredItems failed due to
 * a network interruption and the client does not know if the creation succeeded in the server.
 *
 */
Subscription.prototype.getMonitoredItems = function (/*out*/ result) {

    result = result || {};
    var subscription = this;
    result.serverHandles = [];
    result.clientHandles = [];
    result.statusCode = StatusCodes.Good;

    Object.keys(subscription.monitoredItems).forEach(function (monitoredItemId) {

        var monitoredItem = subscription.getMonitoredItem(monitoredItemId);

        result.clientHandles.push(monitoredItem.clientHandle);
        // TODO:  serverHandle is defined anywhere in the OPCUA Specification 1.02
        //        I am not sure what shall be reported for serverHandle...
        //        using monitoredItem.monitoredItemId instead...
        //        May be a clarification in the OPCUA Spec is required.
        result.serverHandles.push(monitoredItemId);

    });
    return result;
};

MonitoredItem.prototype.resendInitialValues = function() {
    // tte first Publish response(s) after the TransferSubscriptions call shall contain the current values of all
    // Monitored Items in the Subscription where the Monitoring Mode is set to Reporting.
    // the first Publish response after the TransferSubscriptions call shall contain only the value changes since
    // the last Publish response was sent.
    // This parameter only applies to MonitoredItems used for monitoring Attribute changes.
    var self = this;
    self._stop_sampling();
    self._start_sampling(true);
};

Subscription.prototype.resendInitialValues = function(){
    var subscription = this;
    _.forEach(subscription.monitoredItems,function (monitoredItem/*,monitoredItemId*/) {
        monitoredItem.resendInitialValues();
    });
};


/**
 * remove a monitored Item from the subscription.
 * @method removeMonitoredItem
 * @param monitoredItemId  {Number} the id of the monitored item to get.
 */
Subscription.prototype.removeMonitoredItem = function (monitoredItemId) {

    debugLog(&quot;Removing monitoredIem &quot;, monitoredItemId);

    assert(_.isFinite(monitoredItemId));
    var self = this;
    if (!self.monitoredItems.hasOwnProperty(monitoredItemId)) {
        return StatusCodes.BadMonitoredItemIdInvalid;
    }

    var monitoredItem = self.monitoredItems[monitoredItemId];

    monitoredItem.terminate();

    /**
     *
     * notify that a monitored item has been removed from the subscription
     * @event removeMonitoredItem
     * @param monitoredItem {MonitoredItem}
     */
    self.emit(&quot;removeMonitoredItem&quot;, monitoredItem);

    delete self.monitoredItems[monitoredItemId];

    return StatusCodes.Good;

};



/**
 * @property hasMonitoredItemNotifications true if monitored Item have uncollected Notifications
 * @type {Boolean}
 */
Subscription.prototype.__defineGetter__(&quot;hasMonitoredItemNotifications&quot;, function () {
    var self = this;
    if (self._hasMonitoredItemNotifications) {
        return true;
    }
    var keys = Object.keys(self.monitoredItems);
    var i,key;
    var n = keys.length;
    for (i=0;i&lt;n;i++) {
        key = keys[i];
        var monitoredItem = self.monitoredItems[key];
        if (monitoredItem.hasMonitoredItemNotifications) {
            self._hasMonitoredItemNotifications = true;
            return true;
        }
    }
    return false;
});

/**
 * extract up to maxNotificationsPerPublish notifications
 * @param monitoredItems
 * @param maxNotificationsPerPublish
 * @return {Array}
 */
function extract_notifications_chunk(monitoredItems, maxNotificationsPerPublish) {

    var n = maxNotificationsPerPublish === 0 ?
        monitoredItems.length :
        Math.min(monitoredItems.length, maxNotificationsPerPublish);

    var chunk_monitoredItems = [];
    while (n) {
        chunk_monitoredItems.push(monitoredItems.shift());
        n--;
    }
    return chunk_monitoredItems;
}

function add_all_in(notifications,all_notifications) {
  for(var i =0;i &lt;notifications.length;i++) {
      var n = notifications[i];
      all_notifications.push(n);
  }
}

function filter_instanceof(Class,e) {
    return (e instanceof Class);
}
// collect DataChangeNotification
Subscription.prototype._collectNotificationData = function () {

    var self = this;
    var notifications = [];

    // reset cache ...
    self._hasMonitoredItemNotifications = false;

    var all_notifications = new Dequeue();

    // visit all monitored items
    var keys = Object.keys(self.monitoredItems);
    var i,key;
    var n = keys.length;
    for (i=0;i&lt;n;i++) {
        key = keys[i];
        var monitoredItem = self.monitoredItems[key];
        notifications = monitoredItem.extractMonitoredItemNotifications();
        add_all_in(notifications,all_notifications);
    }

    var notificationsMessage = [];

    while (all_notifications.length &gt; 0) {

        // split into one or multiple dataChangeNotification with no more than
        //  self.maxNotificationsPerPublish monitoredItems
        var notifications_chunk = extract_notifications_chunk(all_notifications, self.maxNotificationsPerPublish);

        // separate data for DataChangeNotification (MonitoredItemNotification) from data for EventNotificationList(EventFieldList)
        var dataChangedNotificationData = notifications_chunk.filter(filter_instanceof.bind(null,subscription_service.MonitoredItemNotification));
        var eventNotificationListData = notifications_chunk.filter(filter_instanceof.bind(null,subscription_service.EventFieldList));

        assert(notifications_chunk.length === dataChangedNotificationData.length +  eventNotificationListData.length);

        notifications = [];

        // add dataChangeNotification
        if (dataChangedNotificationData.length) {
            var dataChangeNotification = new DataChangeNotification({
                monitoredItems: dataChangedNotificationData,
                diagnosticInfos: []
            });
            notifications.push(dataChangeNotification);
        }

        // add dataChangeNotification
        if (eventNotificationListData.length) {
            var eventNotificationList = new EventNotificationList({
                events: eventNotificationListData
            });

            notifications.push(eventNotificationList);
        }

        assert(notifications.length === 1 || notifications.length === 2);
        notificationsMessage.push(notifications);
    }

    assert(notificationsMessage instanceof Array);
    return notificationsMessage;
};

Subscription.prototype._harvestMonitoredItems = function () {

    var self = this;

    // Only collect data change notification for the time being
    var notificationData = self._collectNotificationData();
    assert(notificationData instanceof Array);

    // istanbul ignore next
    if (doDebug) {
        debugLog(&quot;Subscription#_harvestMonitoredItems =&gt;&quot;,notificationData.length);
    }
    notificationData.forEach(function (notificationMessage) {
        self._addNotificationMessage(notificationMessage);
    });
    self._hasMonitoredItemNotifications = false;

};
Subscription.prototype.__defineGetter__(&quot;subscriptionId&quot;,function(){ return this.id; });


Subscription.prototype.notifyTransfer = function() {

    // OPCUA UA Spec 1.0.3 : part 3 - page 82 - 5.13.7 TransferSubscriptions:
    // If the Server transfers the Subscription to the new Session, the Server shall issue a StatusChangeNotification
    // notificationMessage with the status code Good_SubscriptionTransferred to the old Session.
    var self = this;

    console.warn(&quot; Subscription =&gt; Notifying Transfer                                  &quot;.bgWhite.red);

    var notificationData = [new StatusChangeNotification({statusCode: StatusCodes.GoodSubscriptionTransferred})];

    self.publishEngine.send_notification_message({
        subscriptionId: self.id,
        sequenceNumber: self._get_next_sequence_number(),
        notificationData: notificationData,
        moreNotifications: false
    },true);

};


exports.Subscription = Subscription;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
